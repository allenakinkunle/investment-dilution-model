<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>InfraRed â€” Equity &amp; Dilution Model</title>
<style>
  :root {
    --bg: #ffffff;
    --surface: #f8f9fa;
    --border: #e0e4e8;
    --accent: #00a870;
    --accent2: #e55a2b;
    --accent3: #2d7dd2;
    --text: #1a1a2e;
    --muted: #5a6270;
    --card: #f0f2f5;
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    background: var(--bg);
    font-family: Arial, Helvetica, sans-serif;
    color: var(--text);
    font-size: 15px;
    line-height: 1.6;
    min-height: 100vh;
  }

  .noise {
    position: fixed; inset: 0; pointer-events: none; z-index: 0;
    opacity: 0.025;
    background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)'/%3E%3C/svg%3E");
  }

  .container { max-width: 1100px; margin: 0 auto; padding: 48px 24px; position: relative; z-index: 1; }

  header {
    border-bottom: 1px solid var(--border);
    padding-bottom: 32px;
    margin-bottom: 48px;
    display: flex;
    justify-content: space-between;
    align-items: flex-end;
    flex-wrap: wrap;
    gap: 16px;
  }

  .logo-area h1 {
    font-family: 'Syne', sans-serif;
    font-size: 34px;
    font-weight: 800;
    letter-spacing: -0.5px;
    color: var(--text);
  }
  .logo-area p { color: var(--muted); font-size: 14px; margin-top: 4px; }

  .badge {
    background: linear-gradient(135deg, var(--accent)22, var(--accent)08);
    border: 1px solid var(--accent)44;
    color: var(--accent);
    padding: 6px 14px;
    border-radius: 4px;
    font-size: 11px;
    font-weight: 500;
    letter-spacing: 1px;
    text-transform: uppercase;
  }

  /* EXPLAINER SECTION */
  .section-label {
    font-family: 'Syne', sans-serif;
    font-size: 14px;
    font-weight: 600;
    letter-spacing: 3px;
    text-transform: uppercase;
    color: var(--accent);
    margin-bottom: 20px;
    display: flex;
    align-items: center;
    gap: 10px;
  }
  .section-label::after { content: ''; flex: 1; height: 1px; background: var(--border); }

  .explainer-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 16px;
    margin-bottom: 48px;
  }

  .concept-card {
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 24px;
    position: relative;
    overflow: hidden;
  }
  .concept-card::before {
    content: '';
    position: absolute;
    top: 0; left: 0; right: 0;
    height: 2px;
  }
  .concept-card.green::before { background: var(--accent); }
  .concept-card.orange::before { background: var(--accent2); }
  .concept-card.blue::before { background: var(--accent3); }

  .concept-card h3 {
    font-family: 'Syne', sans-serif;
    font-size: 18px;
    font-weight: 700;
    margin-bottom: 10px;
    color: var(--text);
  }
  .concept-card.green h3 { color: var(--accent); }
  .concept-card.orange h3 { color: var(--accent2); }
  .concept-card.blue h3 { color: var(--accent3); }

  .concept-card p { color: var(--muted); line-height: 1.7; font-size: 15px; }
  .concept-card .example {
    margin-top: 12px;
    padding: 12px 16px;
    background: var(--surface);
    border-radius: 4px;
    font-size: 14px;
    border-left: 3px solid var(--border);
  }
  .concept-card.green .example { border-left-color: var(--accent)66; }
  .concept-card.orange .example { border-left-color: var(--accent2)66; }
  .concept-card.blue .example { border-left-color: var(--accent3)66; }

  /* MODEL SECTION */
  .model-layout {
    display: grid;
    grid-template-columns: 340px 1fr;
    gap: 24px;
    align-items: start;
  }

  @media (max-width: 800px) {
    .container { padding: 24px 16px; }
    .model-layout {
      grid-template-columns: 1fr;
      gap: 32px;
    }
  }

  @media (max-width: 500px) {
    .stage-header {
      flex-wrap: wrap;
      gap: 12px;
    }
    .stage-header .stage-founder-stat {
      width: 100%;
      text-align: left;
    }
    .journey-segment {
      font-size: 10px;
      min-width: 0 !important;
    }
    .investor-row-bottom {
      flex-wrap: wrap;
    }
  }

  .controls-panel {
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 24px;
  }

  @media (min-width: 801px) {
    .controls-panel {
      position: sticky;
      top: 24px;
    }
  }

  .controls-panel h2 {
    font-family: 'Syne', sans-serif;
    font-size: 18px;
    font-weight: 700;
    margin-bottom: 20px;
    color: var(--text);
  }

  .control-group {
    margin-bottom: 20px;
    padding-bottom: 20px;
    border-bottom: 1px solid var(--border);
  }
  .control-group:last-child { border-bottom: none; margin-bottom: 0; padding-bottom: 0; }

  .control-group-title {
    font-size: 12px;
    letter-spacing: 2px;
    text-transform: uppercase;
    color: var(--accent);
    font-weight: 500;
    margin-bottom: 14px;
  }

  .input-row {
    display: flex;
    flex-direction: column;
    gap: 4px;
    margin-bottom: 12px;
  }
  .input-row:last-child { margin-bottom: 0; }

  label {
    font-size: 13px;
    color: var(--muted);
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  label .val {
    font-weight: 500;
    color: var(--text);
    background: var(--surface);
    padding: 2px 8px;
    border-radius: 3px;
    border: 1px solid var(--border);
    min-width: 70px;
    text-align: right;
    font-size: 13px;
  }

  input[type=range] {
    width: 100%;
    height: 4px;
    appearance: none;
    background: var(--border);
    border-radius: 2px;
    outline: none;
    cursor: pointer;
  }
  input[type=range]::-webkit-slider-thumb {
    appearance: none;
    width: 14px; height: 14px;
    border-radius: 50%;
    background: var(--accent);
    cursor: pointer;
    transition: transform 0.1s;
  }
  input[type=range]::-webkit-slider-thumb:hover { transform: scale(1.2); }

  /* RESULTS */
  .results-panel { display: flex; flex-direction: column; gap: 20px; }

  .stage-card {
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 8px;
    overflow: hidden;
    transition: border-color 0.2s;
  }
  .stage-card:hover { border-color: var(--accent)44; }

  .stage-header {
    padding: 16px 20px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: var(--surface);
    border-bottom: 1px solid var(--border);
    cursor: pointer;
    user-select: none;
  }

  .stage-header-left { display: flex; align-items: center; gap: 12px; }

  .stage-num {
    width: 32px; height: 32px;
    border-radius: 50%;
    border: 1px solid var(--accent)55;
    display: flex; align-items: center; justify-content: center;
    font-size: 13px;
    color: var(--accent);
    font-weight: 600;
    flex-shrink: 0;
  }

  .stage-header h3 {
    font-family: 'Syne', sans-serif;
    font-size: 16px;
    font-weight: 700;
    color: var(--text);
  }
  .stage-header .stage-sub { font-size: 13px; color: var(--muted); margin-top: 2px; }

  .stage-founder-stat {
    text-align: right;
  }
  .stage-founder-stat .pct {
    font-family: 'Syne', sans-serif;
    font-size: 26px;
    font-weight: 800;
    color: var(--accent);
    line-height: 1;
  }
  .stage-founder-stat .lbl { font-size: 12px; color: var(--muted); margin-top: 2px; }

  .stage-body { padding: 20px; }

  .cap-table {
    width: 100%;
    border-collapse: collapse;
    margin-bottom: 16px;
  }

  .cap-table th {
    text-align: left;
    font-size: 12px;
    letter-spacing: 1.5px;
    text-transform: uppercase;
    color: var(--muted);
    padding: 0 0 10px;
    font-weight: 500;
    border-bottom: 1px solid var(--border);
  }
  .cap-table th:last-child { text-align: right; }

  .cap-table td {
    padding: 10px 0;
    font-size: 14px;
    border-bottom: 1px solid var(--border)66;
    vertical-align: middle;
  }
  .cap-table td:last-child { text-align: right; }
  .cap-table tr:last-child td { border-bottom: none; }

  .cap-table .party-name { font-weight: 500; color: var(--text); }
  .cap-table .party-basis { color: var(--muted); font-size: 13px; }
  .cap-table .pct-val { font-weight: 600; }
  .cap-table .founders-row td { color: var(--accent); }
  .cap-table .new-row td .party-name { color: var(--accent2); }

  .bar-wrapper {
    height: 6px;
    background: var(--border);
    border-radius: 3px;
    margin-top: 4px;
    overflow: hidden;
    width: 100px;
  }
  .bar-fill {
    height: 100%;
    border-radius: 3px;
    background: var(--accent)66;
    transition: width 0.4s cubic-bezier(.4,0,.2,1);
  }
  .founders-row .bar-fill { background: var(--accent); }
  .new-row .bar-fill { background: var(--accent2)99; }

  .stage-insight {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 6px;
    padding: 14px 18px;
    font-size: 15px;
    color: var(--muted);
    line-height: 1.6;
  }
  .stage-insight strong { color: var(--text); }

  /* SUMMARY BAR */
  .summary-track {
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 24px;
    margin-bottom: 24px;
  }
  .summary-track h2 {
    font-family: 'Syne', sans-serif;
    font-size: 18px;
    font-weight: 700;
    margin-bottom: 18px;
    color: var(--text);
  }

  .journey-bar {
    display: flex;
    gap: 2px;
    height: 40px;
    border-radius: 6px;
    overflow: hidden;
    margin-bottom: 12px;
  }

  .journey-segment {
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 12px;
    font-weight: 600;
    color: rgba(0,0,0,0.75);
    transition: width 0.5s cubic-bezier(.4,0,.2,1);
    white-space: nowrap;
    overflow: hidden;
    padding: 0 4px;
  }

  .journey-legend {
    display: flex;
    gap: 16px;
    flex-wrap: wrap;
    margin-top: 12px;
  }
  .legend-item {
    display: flex;
    align-items: center;
    gap: 6px;
    font-size: 14px;
    color: var(--muted);
  }
  .legend-dot {
    width: 8px; height: 8px;
    border-radius: 2px;
    flex-shrink: 0;
  }

  .stage-connector {
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--muted);
    font-size: 11px;
    gap: 8px;
    padding: 4px 0;
  }
  .stage-connector::before, .stage-connector::after {
    content: ''; flex: 1; height: 1px; background: var(--border);
  }

  .toggle-icon { transition: transform 0.2s; color: var(--muted); }
  .stage-body.collapsed { display: none; }
  .toggled .toggle-icon { transform: rotate(180deg); }

  input[type=number] {
    background: var(--surface);
    border: 1px solid var(--border);
    color: var(--text);
    padding: 6px 10px;
    border-radius: 4px;
    font-family: 'DM Mono', monospace;
    font-size: 12px;
    width: 100%;
    outline: none;
    transition: border-color 0.2s;
  }
  input[type=number]:focus { border-color: var(--accent)88; }

  /* NEW STYLES */
  input[type=text] {
    background: var(--surface);
    border: 1px solid var(--border);
    color: var(--text);
    padding: 6px 10px;
    border-radius: 4px;
    font-family: Arial, Helvetica, sans-serif;
    font-size: 13px;
    width: 100%;
    outline: none;
    transition: border-color 0.2s;
  }
  input[type=text]:focus { border-color: var(--accent)88; }

  .investor-row {
    display: flex;
    flex-direction: column;
    gap: 6px;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 6px;
    padding: 10px;
    margin-bottom: 8px;
  }

  .investor-row-top {
    display: flex;
    gap: 6px;
    align-items: center;
  }

  .investor-row-bottom {
    display: flex;
    gap: 6px;
    align-items: center;
  }

  .inv-name-input {
    flex: 1;
    min-width: 0;
  }

  .inv-num-input {
    width: 110px;
  }

  .mfn-badge {
    background: #10b981;
    color: white;
    font-size: 11px;
    padding: 4px 8px;
    border-radius: 3px;
    font-weight: 600;
    white-space: nowrap;
    flex-shrink: 0;
  }

  .mfn-toggle {
    display: flex;
    align-items: center;
    gap: 4px;
    font-size: 12px;
    color: var(--muted);
    cursor: pointer;
    white-space: nowrap;
    justify-content: flex-start;
    font-weight: normal;
  }

  .remove-btn {
    background: none;
    border: 1px solid var(--border);
    color: var(--muted);
    width: 24px;
    height: 24px;
    border-radius: 4px;
    cursor: pointer;
    font-size: 16px;
    line-height: 1;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
    transition: color 0.2s, border-color 0.2s;
    padding: 0;
  }
  .remove-btn:hover { color: #ef4444; border-color: #ef4444; }

  .add-btn {
    width: 100%;
    padding: 8px;
    background: none;
    border: 1px dashed var(--border);
    border-radius: 6px;
    color: var(--muted);
    cursor: pointer;
    font-size: 13px;
    transition: border-color 0.2s, color 0.2s;
    margin-top: 4px;
  }
  .add-btn:hover { border-color: var(--accent); color: var(--accent); }

  .preseed-summary {
    padding: 8px 12px;
    background: var(--accent)0a;
    border: 1px solid var(--accent)22;
    border-radius: 4px;
    font-size: 11px;
    color: var(--muted);
    margin-top: 4px;
  }

  .accel-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 14px;
  }

  .accel-enable-label {
    display: flex;
    align-items: center;
    gap: 6px;
    font-size: 12px;
    color: var(--muted);
    cursor: pointer;
    font-weight: normal;
    justify-content: flex-start;
  }
</style>
</head>
<body>
<div class="noise"></div>
<div class="container">

  <header>
    <div class="logo-area">
      <h1 id="headerTitle">InfraRed â€” Equity Model</h1>
      <p>Equity &amp; Dilution walkthrough Â· February 2026</p>
    </div>
    <div class="badge">Confidential</div>
  </header>

  <!-- EXPLAINER -->
  <div class="section-label">Key Concepts â€” Plain English</div>
  <div class="explainer-grid">
    <div class="concept-card green">
      <h3>What is a SAFE?</h3>
      <p>A SAFE (Simple Agreement for Future Equity) is not a loan and not shares yet. It's a promise that when a future funding round happens, your investor's money converts into shares at an agreed price. It lets you raise money now without having to officially price the company.</p>
      <div class="example">DFS Lab gives InfraRed $100K today. InfraRed doesn't issue shares immediately. When a priced round happens (like YC or Seed), the $100K converts into shares automatically.</div>
    </div>
    <div class="concept-card orange">
      <h3>What is a Valuation Cap?</h3>
      <p>The cap is the maximum valuation at which your SAFE converts into shares. It protects early investors â€” even if your company is worth $10M when it converts, they convert as if it's worth the cap. This means they get more shares for their money.</p>
      <div class="example">DFS Lab's cap is $3.5M (in your scenario). If InfraRed is worth $10M at Seed, DFS Lab still converts as if it's $3.5M â€” giving them a better deal as reward for investing early.</div>
    </div>
    <div class="concept-card blue">
      <h3>What is Dilution?</h3>
      <p>Every time you issue new shares (for investors, employees, etc.), the total number of shares grows â€” so each existing share represents a smaller slice of the pie. Your ownership % goes down. This is dilution. It's not necessarily bad â€” a smaller % of a bigger, more valuable company can be worth far more.</p>
      <div class="example">You own 90% of a $1M company = $900K. After dilution you own 51% of a $40M company = $20.4M. The % dropped but the value exploded.</div>
    </div>
    <div class="concept-card green">
      <h3>What is an ESOP Pool?</h3>
      <p>An Employee Stock Option Pool (ESOP) is equity set aside to hire and retain employees. Investors typically require a 10-15% pool to be created before their investment, which dilutes founders. Managing how fast you grant options matters a lot.</p>
      <div class="example">If you've given away most of your 10% ESOP pool by Series A, investors will demand you top it back up to ~12% before the round closes. Every point of that top-up comes from founders, not investors.</div>
    </div>
    <div class="concept-card orange">
      <h3>What is an MFN Clause?</h3>
      <p>Most Favoured Nation means an uncapped SAFE investor gets to convert at whatever the best terms are among future investors. Your existing $25K angels have uncapped SAFEs with MFN â€” they'll automatically get DFS Lab's $3.5M cap, because that's the reference price.</p>
      <div class="example">Angel invested $25K on an uncapped SAFE + MFN. DFS Lab comes in at $3.5M cap. Angel now converts at $3.5M cap too â€” same as DFS Lab.</div>
    </div>
    <div class="concept-card blue">
      <h3>Post-Money vs Pre-Money SAFE</h3>
      <p>A post-money SAFE fixes your ownership % at the time of signing, regardless of who else invests later. $100K / $3.5M cap = 2.86% â€” that's DFS Lab's share, locked. A pre-money SAFE would mean more investors reduce DFS Lab's share. Post-money is cleaner and more predictable for both sides.</p>
      <div class="example">DFS Lab: $100K / $3.5M = 2.86% ownership, locked at signing. Even if more angels pile in, DFS Lab stays at 2.86%.</div>
    </div>
  </div>

  <!-- SUMMARY -->
  <div class="section-label">Founder Ownership Journey</div>
  <div class="summary-track">
    <h2>How Founder Ownership Shrinks Stage by Stage</h2>
    <div class="journey-bar" id="journeyBar"></div>
    <div class="journey-legend" id="journeyLegend"></div>
  </div>

  <!-- MODEL -->
  <div class="section-label">Interactive Model â€” Adjust the Numbers</div>
  <div class="model-layout">

    <div class="controls-panel">
      <h2>âš™ Model Inputs</h2>

      <!-- Company -->
      <div class="control-group">
        <div class="control-group-title">Company</div>
        <div class="input-row">
          <label>Company Name</label>
          <input type="text" id="companyName" value="InfraRed" oninput="render()">
        </div>
        <div class="input-row">
          <label>ESOP Pool <span class="val" id="v_esop">10%</span></label>
          <input type="range" id="esop" min="5" max="20" step="0.5" value="10">
        </div>
      </div>

      <!-- Pre-Seed Investors -->
      <div class="control-group">
        <div class="control-group-title">Pre-Seed Investors</div>
        <div id="investorList"></div>
        <div id="preseedSummary" class="preseed-summary"></div>
        <button class="add-btn" onclick="addInvestor()">+ Add Investor</button>
      </div>

      <!-- Accelerator -->
      <div class="control-group">
        <div class="accel-header">
          <div class="control-group-title" style="margin-bottom:0">Accelerator</div>
          <label class="accel-enable-label">
            <input type="checkbox" id="accelEnabled" checked onchange="toggleAccel()"> Enable
          </label>
        </div>
        <div id="accelInputs">
          <div class="input-row">
            <label>Name</label>
            <input type="text" id="accelName" value="YC" oninput="render()">
          </div>
          <div class="input-row">
            <label>Tranche 1 Amount</label>
            <input type="number" id="accelT1Amount" value="125000" oninput="render()">
          </div>
          <div class="input-row">
            <label>Tranche 1 % <span class="val" id="v_yc1">7%</span></label>
            <input type="range" id="yc1" min="5" max="10" step="0.5" value="7">
          </div>
          <div class="input-row">
            <label>Tranche 2 Amount <small style="color:var(--muted)">(0 to skip)</small></label>
            <input type="number" id="accelT2Amount" value="375000" oninput="render()">
          </div>
        </div>
      </div>

      <!-- Seed -->
      <div class="control-group">
        <div class="control-group-title">Seed Round</div>
        <div class="input-row">
          <label>Seed Raise <span class="val" id="v_seedraise">$1.5M</span></label>
          <input type="range" id="seedraise" min="500000" max="4000000" step="100000" value="1500000">
        </div>
        <div class="input-row">
          <label>Seed Post-Money Val. <span class="val" id="v_seedval">$15M</span></label>
          <input type="range" id="seedval" min="5000000" max="40000000" step="500000" value="15000000">
        </div>
      </div>

      <!-- Series A -->
      <div class="control-group">
        <div class="control-group-title">Series A</div>
        <div class="input-row">
          <label>Series A % Sold <span class="val" id="v_seriesapct">20%</span></label>
          <input type="range" id="seriesapct" min="10" max="35" step="1" value="20">
        </div>
        <div class="input-row">
          <label>Series A Post-Money <span class="val" id="v_seriesaval">$40M</span></label>
          <input type="range" id="seriesaval" min="15000000" max="120000000" step="1000000" value="40000000">
        </div>
      </div>
    </div>

    <div class="results-panel" id="resultsPanel"></div>
  </div>

</div>

<script>
const fmt = (n, decimals=1) => n.toFixed(decimals) + '%';
const fmtM = (n) => {
  if (n >= 1000000) return '$' + (n/1000000).toFixed(2).replace(/\.?0+$/, '') + 'M';
  if (n >= 1000) return '$' + (n/1000).toFixed(0) + 'K';
  return '$' + n;
};

let investors = [
  { id: 1, name: 'DFS Lab',        amount: 100000, cap: 3500000, mfn: false },
  { id: 2, name: 'Angels',         amount: 25000,  cap: 3500000, mfn: true  },
  { id: 3, name: 'Other Pre-Seed', amount: 225000, cap: 3500000, mfn: false },
];
let nextId = 4;
const INV_PALETTE = ['#a78bfa','#e879f9','#34d399','#60a5fa','#fb923c','#f472b6','#38bdf8','#4ade80'];

function addInvestor() {
  const nonMfn = investors.filter(i => !i.mfn && i.amount > 0 && i.cap > 0);
  const defaultCap = nonMfn.length > 0 ? Math.min(...nonMfn.map(i => i.cap)) : 3500000;
  investors.push({ id: nextId++, name: 'New Investor', amount: 50000, cap: defaultCap, mfn: false });
  renderInvestorList();
  render();
}

function removeInvestor(id) {
  investors = investors.filter(i => i.id !== id);
  renderInvestorList();
  render();
}

function updateInvestorField(id, field, val) {
  const inv = investors.find(i => i.id === id);
  if (!inv) return;
  inv[field] = val;
  if (field === 'mfn') renderInvestorList();
  render();
}

function renderInvestorList() {
  const container = document.getElementById('investorList');
  if (!container) return;
  container.innerHTML = investors.map((inv, idx) => {
    const color = INV_PALETTE[idx % INV_PALETTE.length];
    const capField = inv.mfn
      ? `<span class="mfn-badge">MFN Cap</span>`
      : `<input type="number" class="inv-num-input" value="${inv.cap}"
           oninput="updateInvestorField(${inv.id}, 'cap', +this.value)"
           title="Valuation Cap">`;
    return `<div class="investor-row">
      <div class="investor-row-top">
        <div class="legend-dot" style="background:${color};flex-shrink:0"></div>
        <input type="text" class="inv-name-input" value="${inv.name.replace(/"/g, '&quot;')}"
          oninput="updateInvestorField(${inv.id}, 'name', this.value)">
        <button class="remove-btn" onclick="removeInvestor(${inv.id})">Ã—</button>
      </div>
      <div class="investor-row-bottom">
        <input type="number" class="inv-num-input" value="${inv.amount}"
          oninput="updateInvestorField(${inv.id}, 'amount', +this.value)"
          title="Investment Amount">
        ${capField}
        <label class="mfn-toggle">
          <input type="checkbox" ${inv.mfn ? 'checked' : ''}
            onchange="updateInvestorField(${inv.id}, 'mfn', this.checked)"> MFN
        </label>
      </div>
    </div>`;
  }).join('');
}

function toggleAccel() {
  const enabled = document.getElementById('accelEnabled').checked;
  const inputs = document.getElementById('accelInputs');
  if (inputs) inputs.style.display = enabled ? '' : 'none';
  render();
}

function getInputs() {
  return {
    companyName: document.getElementById('companyName').value || 'Company',
    investors: investors,
    accel: {
      enabled: document.getElementById('accelEnabled').checked,
      name: document.getElementById('accelName').value || 'Accelerator',
      t1Amount: +document.getElementById('accelT1Amount').value || 0,
      t1Pct: +document.getElementById('yc1').value / 100,
      t2Amount: +document.getElementById('accelT2Amount').value || 0,
    },
    esop: +document.getElementById('esop').value / 100,
    seedRaise: +document.getElementById('seedraise').value,
    seedVal: +document.getElementById('seedval').value,
    seriesAPct: +document.getElementById('seriesapct').value / 100,
    seriesAVal: +document.getElementById('seriesaval').value,
  };
}

function compute(inp) {
  const { investors: invs, accel, esop, seedRaise, seedVal, seriesAPct, seriesAVal, companyName } = inp;

  // MFN effective cap = min cap among non-MFN investors with non-zero amounts
  const nonMfnCaps = invs.filter(i => !i.mfn && i.amount > 0 && i.cap > 0).map(i => i.cap);
  const mfnEffectiveCap = nonMfnCaps.length > 0 ? Math.min(...nonMfnCaps) : 0;

  // Pre-seed ownership per investor
  const invOwn = invs.map((inv, idx) => {
    const effectiveCap = inv.mfn ? mfnEffectiveCap : inv.cap;
    const pct = (inv.amount > 0 && effectiveCap > 0) ? inv.amount / effectiveCap : 0;
    return { ...inv, pct, color: INV_PALETTE[idx % INV_PALETTE.length] };
  });
  const totalInvPct = invOwn.reduce((a, i) => a + i.pct, 0);

  const esopFrac = esop;
  const accelT1Frac = accel.enabled ? accel.t1Pct : 0;
  const foundersAfterAccel = Math.max(0, 1 - totalInvPct - esopFrac - accelT1Frac);

  // Seed
  const newSeedFrac = seedRaise / seedVal;
  const accelT2Frac = (accel.enabled && accel.t2Amount > 0) ? accel.t2Amount / seedVal : 0;
  const seedDilution = newSeedFrac + accelT2Frac;
  const seedRetain = 1 - seedDilution;

  const foundersAfterSeed = foundersAfterAccel * seedRetain;
  const invAfterSeed = invOwn.map(i => ({ ...i, pct: i.pct * seedRetain }));
  const esopAfterSeed = esopFrac * seedRetain;
  const accelT1AfterSeed = accelT1Frac * seedRetain;

  // Series A
  const saRetain = 1 - seriesAPct;
  const foundersAfterSeriesA = foundersAfterSeed * saRetain;
  const invAfterSeriesA = invAfterSeed.map(i => ({ ...i, pct: i.pct * saRetain }));
  const esopAfterSeriesA = esopAfterSeed * saRetain;
  const accelT1AfterSeriesA = accelT1AfterSeed * saRetain;
  const accelT2AfterSeriesA = accelT2Frac * seedRetain * saRetain;
  const newSeedAfterSeriesA = newSeedFrac * seedRetain * saRetain;

  const founderValueAtSeriesA = foundersAfterSeriesA * seriesAVal;
  const totalPreseed = invs.reduce((a, i) => a + i.amount, 0);
  const accelLabel = accel.name;

  const hasMfn = invs.some(i => i.mfn && i.amount > 0);
  const mfnNote = (hasMfn && mfnEffectiveCap > 0)
    ? ` MFN investors convert at the lowest non-MFN cap of ${fmtM(mfnEffectiveCap)}.`
    : '';

  // Stage 1
  const stage1Title = accel.enabled ? `Post-${accelLabel}` : 'Initial Cap Table';
  const stage1Sub = accel.enabled
    ? `${accelLabel} ${fmtM(accel.t1Amount)} converts at fixed ${fmt(accel.t1Pct * 100, 0)}`
    : 'Pre-seed investors + ESOP';
  const stage1Rows = [
    { name: `${companyName} Founders`, basis: 'Remainder after all stakeholders', pct: foundersAfterAccel * 100, color: '#00e5a0', isFounder: true },
    { name: 'ESOP Pool', basis: `${(esop * 100).toFixed(1)}% reserved for team`, pct: esopFrac * 100, color: '#4d9fff' },
    ...(accel.enabled ? [{ name: `${accelLabel} (${fmtM(accel.t1Amount)} tranche)`, basis: `Fixed ${fmt(accel.t1Pct * 100, 0)} post-money`, pct: accelT1Frac * 100, color: '#fbbf24', isNew: true }] : []),
    ...invOwn.map(i => ({
      name: i.name,
      basis: `${fmtM(i.amount)} / ${fmtM(i.mfn ? mfnEffectiveCap : i.cap)} ${i.mfn ? '(MFN)' : 'post-money SAFE'}`,
      pct: i.pct * 100,
      color: i.color,
    })),
  ];
  const stage1Insight = accel.enabled
    ? `The founders own <strong>${fmt(foundersAfterAccel * 100)}</strong> at this stage. Total pre-seed capital of <strong>${fmtM(totalPreseed)}</strong> converts at their respective caps. The ${accelLabel} ${fmtM(accel.t1Amount)} is special â€” it converts at exactly ${fmt(accel.t1Pct * 100, 0)}, no matter what the company is worth.${mfnNote} The ESOP pool is carved out here as well.`
    : `The founders own <strong>${fmt(foundersAfterAccel * 100)}</strong>. Total pre-seed capital of <strong>${fmtM(totalPreseed)}</strong> converts at respective caps.${mfnNote} The ESOP pool is carved out here.`;

  // Stage 2
  const stage2Rows = [
    { name: `${companyName} Founders`, basis: `${fmt(foundersAfterAccel * 100)} diluted by ${fmt(seedDilution * 100)}`, pct: foundersAfterSeed * 100, color: '#00e5a0', isFounder: true },
    { name: 'ESOP Pool', basis: 'Diluted proportionally', pct: esopAfterSeed * 100, color: '#4d9fff' },
    { name: 'New Seed Investors', basis: `${fmtM(seedRaise)} / ${fmtM(seedVal)}`, pct: newSeedFrac * 100, color: '#ff6b35', isNew: true },
    ...(accel.enabled && accel.t1Amount > 0 ? [{ name: `${accelLabel} (${fmtM(accel.t1Amount)})`, basis: 'Diluted proportionally', pct: accelT1AfterSeed * 100, color: '#fbbf24' }] : []),
    ...(accel.enabled && accel.t2Amount > 0 ? [{ name: `${accelLabel} (${fmtM(accel.t2Amount)} MFN)`, basis: `${fmtM(accel.t2Amount)} / ${fmtM(seedVal)} converts at seed`, pct: accelT2Frac * 100, color: '#f59e0b', isNew: true }] : []),
    ...invAfterSeed.map(i => ({ name: i.name, basis: 'Diluted proportionally', pct: i.pct * 100, color: i.color })),
  ];
  const accelT2Part = (accel.enabled && accel.t2Amount > 0)
    ? ` AND ${accelLabel}'s ${fmtM(accel.t2Amount)} second tranche converts at this valuation (taking ${fmt(accelT2Frac * 100)}). `
    : ' ';
  const stage2Lead = (accel.enabled && accel.t2Amount > 0)
    ? `Two things hit at once: new seed investors take ${fmt(newSeedFrac * 100)}${accelT2Part}`
    : `New seed investors take ${fmt(newSeedFrac * 100)}. `;
  const stage2Insight = `${stage2Lead}Combined dilution is <strong>${fmt(seedDilution * 100)}</strong> â€” everyone on the existing cap table shrinks proportionally. Founders drop from ${fmt(foundersAfterAccel * 100)} to <strong>${fmt(foundersAfterSeed * 100)}</strong>.`;

  // Stage 3
  const accelCombinedAfterA = accelT1AfterSeriesA + accelT2AfterSeriesA;
  const stage3Rows = [
    { name: `${companyName} Founders`, basis: `${fmt(foundersAfterSeed * 100)} diluted by ${fmt(seriesAPct * 100, 0)}`, pct: foundersAfterSeriesA * 100, color: '#00e5a0', isFounder: true },
    { name: 'ESOP Pool', basis: 'Pre top-up', pct: esopAfterSeriesA * 100, color: '#4d9fff' },
    { name: 'Series A Investors', basis: `${fmt(seriesAPct * 100, 0)} of company`, pct: seriesAPct * 100, color: '#ff6b35', isNew: true },
    { name: 'New Seed Investors', basis: 'Diluted by Series A', pct: newSeedAfterSeriesA * 100, color: '#ff6b35' },
    ...(accel.enabled && accelCombinedAfterA > 0.0001 ? [{ name: `${accelLabel} (combined)`, basis: 'Both tranches diluted', pct: accelCombinedAfterA * 100, color: '#f59e0b' }] : []),
    ...invAfterSeriesA.map(i => ({ name: i.name, basis: 'Diluted by Series A', pct: i.pct * 100, color: i.color })),
  ];
  const stage3Insight = `Founders land at <strong>${fmt(foundersAfterSeriesA * 100)}</strong> post-Series A. At a ${fmtM(seriesAVal)} valuation, that founder stake is worth approximately <strong>${fmtM(founderValueAtSeriesA)}</strong> on paper. The Series A valuation is the biggest single lever â€” higher ARR, stronger NRR, and more paying customers push that number up and compound favorably for everyone.`;

  return {
    stages: [
      { num: 1, title: stage1Title, sub: stage1Sub, founderPct: foundersAfterAccel * 100, rows: stage1Rows, insight: stage1Insight },
      { num: 2, title: 'Post-Seed', sub: `${fmtM(seedRaise)} raised @ ${fmtM(seedVal)} post-money`, founderPct: foundersAfterSeed * 100, rows: stage2Rows, insight: stage2Insight },
      { num: 3, title: 'Post-Series A', sub: `${fmt(seriesAPct * 100, 0)} sold @ ${fmtM(seriesAVal)} post-money`, founderPct: foundersAfterSeriesA * 100, founderValue: founderValueAtSeriesA, rows: stage3Rows, insight: stage3Insight },
    ],
    founderJourney: [
      { label: 'Pre-seed', pct: Math.max(0, (1 - totalInvPct) * 100) },
      { label: accel.enabled ? `Post-${accelLabel}` : 'With ESOP', pct: foundersAfterAccel * 100 },
      { label: 'Post-Seed', pct: foundersAfterSeed * 100 },
      { label: 'Post-Series A', pct: foundersAfterSeriesA * 100 },
    ],
  };
}

function renderStage(s) {
  const total = s.rows.reduce((a, r) => a + r.pct, 0);
  const rows = s.rows.map(r => {
    const barW = Math.min(100, (r.pct / Math.max(total, 100)) * 100);
    const color = r.color || '#6b7280';
    return `<tr class="${r.isFounder ? 'founders-row' : r.isNew ? 'new-row' : ''}">
      <td>
        <div class="party-name">${r.name}</div>
        <div class="party-basis">${r.basis}</div>
        <div class="bar-wrapper"><div class="bar-fill" style="width:${barW}%;background:${color}66;"></div></div>
      </td>
      <td><span class="pct-val" style="color:${color}">${fmt(r.pct)}</span></td>
    </tr>`;
  }).join('');

  const valueNote = s.founderValue
    ? `<div style="margin-top:10px;padding:8px 12px;background:var(--accent)11;border:1px solid var(--accent)33;border-radius:4px;font-size:12px;color:var(--accent)">ðŸ’° Founder stake value at this valuation: <strong>${fmtM(s.founderValue)}</strong></div>`
    : '';

  return `<div class="stage-card">
    <div class="stage-header" onclick="toggleStage(this)">
      <div class="stage-header-left">
        <div class="stage-num">${s.num}</div>
        <div>
          <h3>${s.title}</h3>
          <div class="stage-sub">${s.sub}</div>
        </div>
      </div>
      <div style="display:flex;align-items:center;gap:16px;">
        <div class="stage-founder-stat">
          <div class="pct">${fmt(s.founderPct)}</div>
          <div class="lbl">Founder ownership</div>
        </div>
        <div class="toggle-icon">â–¼</div>
      </div>
    </div>
    <div class="stage-body">
      <table class="cap-table">
        <thead><tr><th>Party</th><th>Ownership</th></tr></thead>
        <tbody>${rows}</tbody>
      </table>
      ${valueNote}
      <div class="stage-insight">${s.insight}</div>
    </div>
  </div>`;
}

function toggleStage(header) {
  const body = header.nextElementSibling;
  const card = header.parentElement;
  body.classList.toggle('collapsed');
  card.classList.toggle('toggled');
}

function renderJourney(journey) {
  const bar = document.getElementById('journeyBar');
  const legend = document.getElementById('journeyLegend');
  const colors = ['#00e5a0', '#4ade80', '#22d3ee', '#818cf8'];
  bar.innerHTML = journey.map((j, i) =>
    `<div class="journey-segment" style="width:${j.pct}%;background:${colors[i]};min-width:${j.pct > 5 ? '60px' : '0'}">${j.pct > 8 ? fmt(j.pct) : ''}</div>`
  ).join('');
  legend.innerHTML = journey.map((j, i) =>
    `<div class="legend-item"><div class="legend-dot" style="background:${colors[i]}"></div>${j.label}: <strong style="color:${colors[i]};margin-left:4px">${fmt(j.pct)}</strong></div>`
  ).join('');
}

function updateLabels(inp) {
  document.getElementById('v_esop').textContent = (inp.esop * 100).toFixed(1) + '%';
  document.getElementById('v_yc1').textContent = (inp.accel.t1Pct * 100).toFixed(1) + '%';
  document.getElementById('v_seedraise').textContent = fmtM(inp.seedRaise);
  document.getElementById('v_seedval').textContent = fmtM(inp.seedVal);
  document.getElementById('v_seriesapct').textContent = (inp.seriesAPct * 100).toFixed(0) + '%';
  document.getElementById('v_seriesaval').textContent = fmtM(inp.seriesAVal);

  const totalRaise = investors.reduce((a, i) => a + i.amount, 0);
  const nonMfnCaps = investors.filter(i => !i.mfn && i.amount > 0 && i.cap > 0).map(i => i.cap);
  const mfnCap = nonMfnCaps.length > 0 ? Math.min(...nonMfnCaps) : null;
  const hasMfn = investors.some(i => i.mfn && i.amount > 0);
  const mfnNote = (hasMfn && mfnCap)
    ? ` &nbsp;Â·&nbsp; MFN cap: <strong style="color:var(--accent)">${fmtM(mfnCap)}</strong>`
    : '';
  document.getElementById('preseedSummary').innerHTML =
    `Total raise: <strong style="color:var(--accent)">${fmtM(totalRaise)}</strong>${mfnNote}`;
}

function render() {
  const inp = getInputs();
  updateLabels(inp);
  const data = compute(inp);
  renderJourney(data.founderJourney);
  document.getElementById('resultsPanel').innerHTML = data.stages.map(renderStage).join(
    `<div class="stage-connector">dilution event â†“</div>`
  );
  const ht = document.getElementById('headerTitle');
  if (ht) ht.textContent = inp.companyName + ' â€” Equity Model';
  document.title = inp.companyName + ' â€” Equity & Dilution Model';
}

renderInvestorList();
document.querySelectorAll('input[type=range]').forEach(el => el.addEventListener('input', render));
toggleAccel(); // sets initial visibility and calls render()
</script>
</body>
</html>
